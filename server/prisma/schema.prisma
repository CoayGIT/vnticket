// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  cpf       String?  @unique
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  tickets   Ticket[]
  orders    Order[]
  
  @@index([email])
}

model Event {
  id          String   @id @default(cuid())
  name        String
  description String
  date        String
  time        String
  location    String
  image       String
  category    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  ticketTypes TicketType[]
  
  @@index([name])
}

model TicketType {
  id        String   @id @default(cuid())
  eventId   String
  name      String
  price     Float
  available Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tickets   Ticket[]
  
  @@index([eventId])
}

model Order {
  id                   String   @id @default(cuid())
  userId               String
  total                Float
  status               String   @default("pending") // pending, paid, completed, cancelled
  paymentId            String?
  stripePaymentIntentId String?  @unique // Stripe Payment Intent ID
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  user                 User     @relation(fields: [userId], references: [id])
  tickets              Ticket[]
  
  @@index([userId])
  @@index([status])
  @@index([stripePaymentIntentId])
}

model Ticket {
  id           String     @id @default(cuid())
  orderId      String
  userId       String
  ticketTypeId String
  eventId      String
  code         String     @unique
  qrCode       String     @unique // QR Code único baseado no código do ingresso
  status       String     @default("valid") // valid, used, cancelled
  validatedAt  DateTime?  // Data de validação do ingresso
  validatedBy  String?    // ID do usuário que validou (organizador)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  order        Order      @relation(fields: [orderId], references: [id])
  user         User       @relation(fields: [userId], references: [id])
  ticketType   TicketType @relation(fields: [ticketTypeId], references: [id])
  
  @@index([userId])
  @@index([code])
  @@index([qrCode])
  @@index([status])
}
